

<!DOCTYPE html>
<html>
  <head>
    <title>
	Listeners :: Mortar
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2021-02-06T11:40:37 IST">
<meta name="description" content="">



<title>Listeners :: Mortar</title>

<link rel="shortcut icon" href='/images/favicon.png' type="image/x-icon" />

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css">

<script src='https://code.jquery.com/jquery-3.5.1.min.js'></script>

<link href='https://fonts.googleapis.com/css?family=Montserrat:400,700' rel="stylesheet">



<link rel="stylesheet" type="text/css" href='https://go-masonry.github.io/sass/layout.css'>
<link rel="stylesheet" type="text/css" href='https://go-masonry.github.io/css/style.main.css'>
<link rel="stylesheet" type="text/css" href='https://go-masonry.github.io/css/style.menu.css'>
<link rel="stylesheet" type="text/css" href='https://go-masonry.github.io/sass/shortcodes/notice.css'>
<link rel="stylesheet" type="text/css" href='https://go-masonry.github.io/sass/shortcodes/tabs.css'>
<link rel="stylesheet" type="text/css" href='https://go-masonry.github.io/sass/shortcodes/panel.css'>
<link rel="stylesheet" type="text/css" href='https://go-masonry.github.io/sass/shortcodes/columns.css'>
<link rel="stylesheet" type="text/css" href='https://go-masonry.github.io/sass/shortcodes/children.css'>
<link rel="stylesheet" type="text/css" href='https://go-masonry.github.io/sass/shortcodes/attachments.css'>
<link rel="stylesheet" type="text/css" href='https://go-masonry.github.io/sass/shortcodes/alert.css'>
<link rel="stylesheet" type="text/css" href='/css/docport.css'>

<script src='/js/docport.js'></script>
<script type="text/javascript">
      var baseurl = "https:\/\/go-masonry.github.io\/";
</script>




    
  </head>

  <body data-url="/mortar/listeners/"

  class="hidenextpage ">

<style type="text/css">
  #debug{
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    line-height: 3.5rem;
    margin-bottom: .35rem;
    padding: 0 2rem;
    position: fixed;
    left: 0;      right: 0;     top: 0;
   
    top:0px;
    
    min-height: 150px;

    background-color: white;
    border: 3px solid red;
    z-index: 10000 ;
    word-wrap: all;
    overflow: auto;
  }
</style>
 


    
    
    <header style="">
        <div>
    
    <div class="burger ">
        <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">&#9776;</a>
    </div>
    

    <div>

		
	
			
		
	    	<a class='baselink' href='https://go-masonry.github.io/'>Mortar</a>
	  	
	</div>
    <nav class="shortcuts">
            <li class="" role="">
                <a href="https://github.com/go-masonry/mortar-demo"  rel="noopener">
                  Demo
                </a>
            </li>
            <li class="" role="">
                <a href="https://github.com/go-masonry/mortar-template"  rel="noopener">
                  Template
                </a>
            </li>
            <li class="" role="">
                <a href="https://github.com/go-masonry/mortar"  rel="noopener">
                  Github
                </a>
            </li>
            <li class="" role="">
                <a href="https://github.com/go-masonry/mortar/discussions"  rel="noopener">
                  Discussions
                </a>
            </li>
    </nav>

</div>
    </header>
    

    <article>
      
      <aside class="">
        
<div class="search">
	<div class="searchbox">
	  <input data-search-input id="search-by" type="text" placeholder="Type to search...">
	</div>
	<script type="text/javascript" src="/vendor/lunr/lunr.min.js"></script>
	<script type="text/javascript" src="/vendor/auto-complete/auto-complete.js"></script>
	<link href="/vendor/auto-complete/auto-complete.css" rel="stylesheet">
	<script type="text/javascript">
	  
	      var baseurl = "https:\/\/go-masonry.github.io\/";
	  
	</script>
	<script type="text/javascript" src="/js/search.js"></script>
</div>

		
	
			
		
	    	
	  	
	<div id="close_menu">
  <a href="javascript:void(0);" style="font-size:15px;" onclick="$('article > aside').toggleClass('responsive')">
      <i class="fa fa-lg fa-times"></i>
  </a>
</div>

<ul class="menu">

    <li data-nav-id="https://go-masonry.github.io/api/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/api/">APIs</a>
      
        <ul>
              

    <li data-nav-id="https://go-masonry.github.io/api/grpc/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/api/grpc/">gRPC</a>
      
        
      
    </li>
              

    <li data-nav-id="https://go-masonry.github.io/api/grpc-gw/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/api/grpc-gw/">gRPC-Gateway</a>
      
        
      
    </li>
              

    <li data-nav-id="https://go-masonry.github.io/api/handlers/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/api/handlers/">HTTP Handler/Func</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://go-masonry.github.io/clients/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/clients/">Clients</a>
      
        <ul>
              

    <li data-nav-id="https://go-masonry.github.io/clients/grpc/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/clients/grpc/">gRPC Client</a>
      
        
      
    </li>
              

    <li data-nav-id="https://go-masonry.github.io/clients/http/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/clients/http/">HTTP Client</a>
      
        
      
    </li>
              

    <li data-nav-id="https://go-masonry.github.io/clients/interceptors/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/clients/interceptors/">Interceptors</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://go-masonry.github.io/fx/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/fx/">Dependency Injection</a>
      
        <ul>
              

    <li data-nav-id="https://go-masonry.github.io/fx/pattern/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/fx/pattern/">Dependency Pattern</a>
      
        
      
    </li>
              

    <li data-nav-id="https://go-masonry.github.io/fx/groups/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/fx/groups/">Groups</a>
      
        
      
    </li>
              

    <li data-nav-id="https://go-masonry.github.io/fx/tests/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/fx/tests/">Tests</a>
      
        
      
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://go-masonry.github.io/middleware/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      <i class="fas fa-chevron-right ddexp"></i>
        
      
          <a href="/middleware/">Middleware</a>
      
        <ul>
              

    <li data-nav-id="https://go-masonry.github.io/middleware/context/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/middleware/context/">Context</a>
      
        
      
    </li>
              

    <li data-nav-id="https://go-masonry.github.io/middleware/telemetry/" class="dd-item haschildren
        item_level_$level
        ">

      
      
      
      
          <a href="/middleware/telemetry/">Telemetry</a>
      <i class="fas fa-chevron-right ddexp"></i>
        
      
        <ul>
              

    <li data-nav-id="https://go-masonry.github.io/middleware/telemetry/logging/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/middleware/telemetry/logging/">Logging</a>
      
        
      
    </li>
              

    <li data-nav-id="https://go-masonry.github.io/middleware/telemetry/monitoring/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/middleware/telemetry/monitoring/">Monitoring</a>
      
        
      
    </li>
              

    <li data-nav-id="https://go-masonry.github.io/middleware/telemetry/tracing/" class="dd-item
        item_level_$level
        ">

      
      
      
      
          <a href="/middleware/telemetry/tracing/">Tracing</a>
      
        
      
    </li>
        </ul>
    </li>
        </ul>
    </li>
    

    <li data-nav-id="https://go-masonry.github.io/auth/" class="dd-item
        item_level_$level
        ">

      
      
      
      
        
      
          <a href="/auth/">JWT Authentication</a>
      
    </li>
    

    <li data-nav-id="https://go-masonry.github.io/mortar/" class="dd-item parent active
        item_level_$level
        ">

      
      
      
      
        
      
          <a href="/mortar/">Mortar Design</a>
      
    </li>
    



</ul>

		
	
			
		
	    	
	  	
	
      </aside>
      

      <section class="page ">
      
	
    
    
    <nav id="ariane" aria-label="breadcrumb">
      <ol class="ariane">
        
  
  	
		
  
  	
	<li >
      <a class="text-link" href="https://go-masonry.github.io/">
        Home
      </a>
    </li>
	
  
    <li class="">
      <a class="text-link" href="/mortar/">
        Mortar Design
      </a>
    </li>
	
  	
  
    <li class="active">
      
        Listeners
      
    </li>

      </ol>
    </nav>
    
    

    
		
        
		
		
		
		
		
		
		

		
			<h1>Mortar Design<span>Listeners</span></h1>
        

			
			
		

		
				<nav class="subpages">
	            		
	        			
	            	<li >
	            		<a title="$pagetitle" href="/mortar/bricks/">Bricks</a>
	            	</li>
	            		
	        			
	            	<li >
	            		<a title="$pagetitle" href="/mortar/builders/">Builder Pattern</a>
	            	</li>
	            		
	        			
	            	<li >
	            		<a title="$pagetitle" href="/mortar/config/">Configuration Map</a>
	            	</li>
	            		
	        			
	            	<li class="active">
	            		<a title="$pagetitle" href="/mortar/listeners/">Listeners</a>
	            	</li>
	        	</nav> 
		
	

	
	
	<div class="jump-to-section">
		<span onclick="$h = $(this);$h.next('nav').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('nav').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-chevron-right';});});">
  			<span class="fas fa-align-right"></span>
  			Jump to Section
  			<i style=";" class="fas fa-chevron-right"></i>
		</span>
		<nav id="TableOfContents">
  <ul>
    <li><a href="#mortar">Mortar</a>
      <ul>
        <li><a href="#external-grpc-and-rest">External gRPC and REST</a></li>
        <li><a href="#internal-rest">Internal REST</a></li>
      </ul>
    </li>
    <li><a href="#one-listener-one-port">One Listener, One Port</a></li>
  </ul>
</nav>
	</div>
	
	






	<div class="content">
	    <p>We assume that you, like us, don&rsquo;t expose your services to the world without setting up at least a Load Balancer before it/them.
Historically, when we started building webservices, our infrastructure was expecting a single port to forward all the traffic to it from the LoadBalancer.
When we wanted to use gRPC API, as well as REST, we still had to expose everything under one port.
Fortunately, we weren&rsquo;t the first, and we used this excellent <a href="https://github.com/soheilhy/cmux">cmux</a> library to solve that problem.</p>
<p>Now, our services were hosted on AWS using <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/elb-listener-config.html">ELB</a>.
Back then, ELB didn&rsquo;t support HTTP/2. However, from Nov 2020 AWS <a href="https://aws.amazon.com/blogs/aws/new-application-load-balancer-support-for-end-to-end-http-2-and-grpc/">have gRPC support</a>&hellip;</p>
<p>gRPC is based on HTTP/2 and that presented some headache&hellip; Long story short, we switched to <a href="https://www.envoyproxy.io/">Envoy</a> and made the following changes:</p>
<p>Our services now have had 3 listeners and 3 ports respectively:</p>
<ul>
<li>gRPC</li>
<li>External REST, which is a reverse-proxy to gRPC using <a href="https://github.com/grpc-ecosystem/grpc-gateway">grpc-gateway</a>.</li>
<li><a href="#internal-rest">Internal REST</a> which exposes different useful information about the service.</li>
</ul>
<p>While the first 2 were exposed to the Internet, the third one (<strong>Internal</strong>) wasn&rsquo;t.</p>
<h2 ref="mortar" >Mortar</h2><a class="anchor" id="mortar"></a>
<p>Mortar is designed with that in mind. Essentially, you create 3 web services with 3 ports they listen on.
If that setup can&rsquo;t work for you, you can still can do everything with <a href="#one-listener-one-port">1 listener and 1 port</a>.</p>
<p>Let&rsquo;s look at some benefits this approach has.</p>
<h3 ref="external-grpc-and-rest" >External gRPC and REST</h3><a class="anchor" id="external-grpc-and-rest"></a>
<p>Basically, you treat gRPC and External REST as one (but with 2 different ports).
If your Load Balancer doesn&rsquo;t support HTTP/2, it sure does support HTTP/1.
It also can probably give you some <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-listeners.html#listener-configuration">benefits</a> if you use an HTTP listener when routing traffic to the External REST port.</p>
<h3 ref="internal-rest" >Internal REST</h3><a class="anchor" id="internal-rest"></a>
<p>When your services are deployed in some cloud, you need different ways to &ldquo;look&rdquo; into them:</p>
<ul>
<li>What is their version or even better, Git commit.</li>
<li><a href="https://github.com/go-masonry/mortar/blob/master/handlers/self.go#L48">Configuration and environment</a> values.


<div class="notices success">
	<p>Mortar has a <a href="https://github.com/go-masonry/mortar/blob/master/handlers/self.go#L65">simple</a> way to obfuscate passwords, secret, tokens, etc.</p>
</div>
</li>
<li>Sometimes you even want to <a href="https://golang.org/pkg/net/http/pprof/">profile</a> your services by using <a href="https://github.com/go-masonry/mortar/blob/master/handlers/profile.go#L15">provided handlers</a>:
<ul>
<li>
<p>Runtime Stats (Memory, CPU, &hellip;).</p>
</li>
<li>
<p>Flags provided when your service was started:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">service config &lt;path to file&gt; --answer-to-everything<span style="color:#666">=</span><span style="color:#40a070">42</span>
</code></pre></div></li>
<li>
<p>Or <a href="https://github.com/go-masonry/mortar/blob/master/handlers/debug.go#L45">Debug</a> them.</p>
</li>
</ul>
</li>
</ul>
<p>Using Internal Handlers and their dedicated listener and port, you can set up a simple but very effective traffic rule,
by allowing only office/vpn traffic to have access to it.</p>
<h2 ref="one-listener-one-port" >One Listener, One Port</h2><a class="anchor" id="one-listener-one-port"></a>
<p>While multi-listener/port approach is great (well, at least for us), sometimes it&rsquo;s not possible.
You can still achieve everything using 1 listener and 1 port.
Look at the test example <a href="https://github.com/go-masonry/mortar/blob/master/http/server/oneport_test.go">here</a>.</p>

		</div>






	

      </section>

      
      
      <section class="right-menu ">
      
	

		
	
			
		
	    	
	  	
	<div class="TableOfContents">
    <label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What&#39;s on this page</label>
    <nav>
        <ul >
            <li><a href="/mortar/listeners/">Listeners</a></li>
        </ul>
    </nav>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#mortar">Mortar</a>
      <ul>
        <li><a href="#external-grpc-and-rest">External gRPC and REST</a></li>
        <li><a href="#internal-rest">Internal REST</a></li>
      </ul>
    </li>
    <li><a href="#one-listener-one-port">One Listener, One Port</a></li>
  </ul>
</nav>
</div>

		
	
			
		
	    	
	  	
	<div class="Actions">
	<nav>
		<ul>
				
		    
		    
			
		    

    	</ul>
	</nav>
    
</div>

      </section>
      
    </article>
    
    
    <footer>
      

		
	
			
		
	    	
	    
	
    </footer>
    



  </body>
</html>
